<!DOCTYPE html>
<html>

<head>
	<title>AR.js A-Frame</title>
	<script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
	<!-- Assumes AR.js build is in the 'AR.js' directory -->
	<script type='text/javascript' src='../../../three.js/build/ar-threex-location-only.js'></script>
	<script type='text/javascript' src='../../../aframe/build/aframe-ar.js'></script>
	<!-- <script src='./index.js'></script> -->
	<link rel="stylesheet" type="text/css" href="./index.css">
</head>

<body>
	<!-- 
This is using a simulated location. If testing on a mobile device, remove the 
'simulateLatitude' and 'simulateLongitude' properties from 'gps-new-camera' and
change the 'latitude' and 'longitude' properties to a location around 0.001 
degrees from your real location.
-->
	<a-scene vr-mode-ui='enabled: false' arjs='sourceType: webcam; videoTexture: true; debugUIEnabled: true'
		renderer='antialias: true; alpha: true'>
		<a-camera gps-new-camera='gpsMinDistance: 5' arjs-device-orientation-controls='smoothingFactor: 0.1'></a-camera>
		<a-box material="color: yellow" gps-new-entity-place="latitude: -6.315814472286864; longitude: 106.66544171534765"
			position="0 1 0" />
	</a-scene>

	<div id='currentstate'></div>

</body>
<script>

	// define the options object with desired settings
	const options = {
		enableHighAccuracy: true,
		timeout: 1000,
		maximumAge: 0
	};

	function simplifyNumber(str) {
		const num = Number(str); // convert to number
		if (!isNaN(num)) { // check if number is valid
			const formattedNum = num.toFixed(2); // format with 2 decimal places
			return formattedNum; // Output: "123.46"
		} else {
			return null;
		}
	}

	function watchLocation() {
		if (navigator.geolocation) {
			const watchId = setInterval(() => {
				navigator.geolocation.watchPosition(showPosition, errorPosition, options);
			}, 1000);
		} else {
			currentstate.innerHTML = "Geolocation is not supported by this browser.";
		}
	}

	function showPosition(position) {
		const formatter = new Intl.DateTimeFormat("en-US", {
			dateStyle: "medium",
			timeStyle: "medium",
		});
		var currentstate = document.querySelector('#currentstate');
		currentstate.innerHTML = `Latitude/Longitude: ${position.coords.latitude} ${position.coords.longitude}
			<br/>Accuracy: ${simplifyNumber(position.coords.accuracy)}m
			<br/>Altitude: ${simplifyNumber(position.coords.altitude)}m
			<br/>altitudeAccuracy: ${simplifyNumber(position.coords.altitudeAccuracy)}m
			<br/>heading: ${simplifyNumber(position.coords.heading)}deg
			<br/>timestamp: ${formatter.format(new Date(position.timestamp))}`;
	}

	// define the error callback function
	function errorPosition(error) {
		console.error(error);
	}
	// create an IntersectionObserver instance
	const observer = new IntersectionObserver((entries, observer) => {
		// loop through the entries
		entries.forEach(entry => {
			if (entry.target.id === 'currentstate' && entry.isIntersecting) {
				// the target element is now visible in the viewport, so execute your code
				// your code goes here
				watchLocation()
				// stop observing the target element
				observer.unobserve(entry.target);
			}
		});
	});

	// start observing the target element
	const targetElement = document.querySelector('#currentstate');
	if (targetElement) {
		observer.observe(targetElement);
	}
</script>

</html>